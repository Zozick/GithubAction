name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Run Tests and Generate Report
    runs-on: ubuntu-latest

    steps:
    # Шаг 1: Выгрузка репозитория
    - name: Checkout code
      uses: actions/checkout@v4

    # Шаг 2: Настройка окружения Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    # Шаг 3: Установка необходимых модулей
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-html

    # Шаг 4: Создание файла с функциями
    - name: Create math_operations.py
      run: |
        cat > math_operations.py << 'EOF'
        def add(a, b):
            return a + b
        
        def subtract(a, b):
            return a - b
        
        def multiply(a, b):
            return a * b
        
        def divide(a, b):
            if b == 0:
                raise ValueError("Делить на ноль нельзя!")
            return a / b
        EOF

    # Шаг 5: Создание тестов
    - name: Create test file
      run: |
        cat > test_math_operations.py << 'EOF'
        import pytest
        from math_operations import add, subtract, multiply, divide
        
        def test_add():
            assert add(2, 3) == 5
            assert add(-1, 1) == 0
            assert add(0, 0) == 0
            assert add(2.5, 3.5) == 6.0
        
        def test_subtract():
            assert subtract(5, 3) == 2
            assert subtract(0, 5) == -5
            assert subtract(-1, -1) == 0
        
        def test_multiply():
            assert multiply(2, 3) == 6
            assert multiply(0, 5) == 0
            assert multiply(-2, 3) == -6
            assert multiply(2.5, 4) == 10.0
        
        def test_divide():
            assert divide(6, 3) == 2
            assert divide(5, 2) == 2.5
            assert divide(0, 5) == 0
            assert divide(-6, 3) == -2
        
        def test_divide_by_zero():
            with pytest.raises(ValueError, match="Делить на ноль нельзя!"):
                divide(5, 0)
        
        def test_all_operations():
            assert add(multiply(2, 3), subtract(10, 4)) == 12
            assert multiply(add(1, 2), subtract(5, 3)) == 6
        
        class TestMathOperations:
            def test_class_add(self):
                assert add(10, 20) == 30
            
            def test_class_divide(self):
                assert divide(10, 2) == 5
            
            def test_class_divide_error(self):
                with pytest.raises(ValueError):
                    divide(10, 0)
        EOF

    # Шаг 6: Запуск тестов с генерацией HTML отчета
    - name: Run tests with pytest
      run: |
        pytest --html=report.html --self-contained-html -v

    # Шаг 7: Выгрузка отчета тестов как артефакт
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: report.html
        retention-days: 30

    # Шаг 8: Сохранение состояния для следующего job
    - name: Set test status
      run: echo "TEST_STATUS=success" >> $GITHUB_ENV

  quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.result == 'success'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install linters
      run: |
        pip install flake8 pylint black

    - name: Check code style with black
      run: |
        black --check --diff .

    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Lint with pylint
      run: |
        pylint math_operations.py test_math_operations.py || true

  deploy:
    name: Upload Code Artifact
    runs-on: ubuntu-latest
    needs: [test, quality]
    if: needs.test.result == 'success' && needs.quality.result == 'success'

    steps:
    # Шаг 1: Выгрузка репозитория
    - name: Checkout code
      uses: actions/checkout@v4

    # Шаг 2: Создание архива с кодом
    - name: Create source archive
      run: |
        mkdir -p dist
        zip -r dist/source-code.zip . -x ".git/*" ".github/*" "__pycache__/*" "*.pyc" "dist/*"

    # Шаг 3: Выгрузка кода как артефакт
    - name: Upload source code artifact
      uses: actions/upload-artifact@v4
      with:
        name: source-code
        path: dist/source-code.zip
        retention-days: 30

    # Шаг 4: Создание Python пакета
    - name: Create Python package
      run: |
        cat > setup.py << 'EOF'
        from setuptools import setup, find_packages
        
        setup(
            name='math-operations',
            version='1.0.0',
            description='Базовые математические операции',
            author='Your Name',
            packages=find_packages(),
            install_requires=[],
            classifiers=[
                'Programming Language :: Python :: 3',
                'License :: OSI Approved :: MIT License',
            ],
        )
        EOF
        
        python setup.py sdist bdist_wheel
        ls -la dist/

    # Шаг 5: Выгрузка Python пакета
    - name: Upload Python package
      uses: actions/upload-artifact@v4
      with:
        name: python-package
        path: dist/*.whl
        retention-days: 30

  notification:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [test, quality, deploy]
    if: always()

    steps:
    - name: Notify on failure
      if: needs.test.result == 'failure' || needs.quality.result == 'failure'
      run: |
        echo "Tests or quality checks failed!"
        echo "Test result: ${{ needs.test.result }}"
        echo "Quality result: ${{ needs.quality.result }}"
        echo "See artifacts for test reports."